---
title: "Describe data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Describe data}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Here the data is described.

Loading the file with all data:

```{r}
t_all <- readr::read_csv(
  "data_with_added_cols.csv", 
  show_col_types = FALSE
)
knitr::kable(head(t_all))
```

Here, we select only the relevant data:

```{r}
t <- t_all |> dplyr::select(fishID, origin, enclosure, pre_mass, transplant,  cage_mass_mean_deviation_sd, survived)
knitr::kable(head(t))
```

All solutions to the dialog are written here,
and tested below:

```{r}
total_n_fish <- 300
n_fish_control <- 60
n_fish_transplanted <- 240
lowest_pre_mass <- 0.5
highest_pre_mass <- 3.6
n_survived <- 151
n_died <- 89
n_enclosures <- 80
n_enclosures_with_2_fish <- 3
n_enclosures_with_3_fish <- 74
n_enclosures_with_4_fish <- 3
anomous_enclosures <- c("L20", "L25", "L6", "L7", "S22", "S24")
cage_mass_mean_for_l1 <- 1.256667
```

Check consistency of these variables:

```{r}
testthat::expect_equal(
  total_n_fish,
  n_fish_control + n_fish_transplanted
)
testthat::expect_equal(
  n_fish_transplanted,
  n_survived + n_died
)
testthat::expect_equal(
  n_enclosures,
  n_enclosures_with_2_fish + n_enclosures_with_3_fish + n_enclosures_with_4_fish
)
testthat::expect_equal(
  length(anomous_enclosures),
  n_enclosures_with_2_fish + n_enclosures_with_4_fish
)
```

## Dialogue

- The `fishID` column denotes the ID of a fish. How many fish are in this dataset?

```{r}
testthat::expect_equal(total_n_fish, length(unique(t$fishID)))
```

The expected answer is `r total_n_fish`.

- The `origin` column denotes the location where each fish comes from.
  Which location do the fish come from?

```{r}
expected <- c("Lake", "Stream")
created <- unique(t$origin)
testthat::expect_equal(expected, created)
```



- The `transplant` column denotes the location where each fish is transplanted
  to.
  Which locations where the fish transplanted to?

```{r}
expected <- c("Lake", "Stream", "Control")
created <- unique(t$transplant)
testthat::expect_equal(expected, created)
```

- Remove the rows for which the `transplant` value is 'Control'. How
  many fish are left?

```{r}
t_1 <- t |> dplyr::filter(transplant != "Control") 
testthat::expect_equal(n_fish_transplanted, length(unique(t_1$fishID)))
```


- The `pre_mass` column denotes the mass of a fish before the transplantation.
  What is the range of the values in this column?

```{r}
testthat::expect_equal(lowest_pre_mass, min(t_1$pre_mass))
testthat::expect_equal(highest_pre_mass, max(t_1$pre_mass))
```

- The `survived` column denotes if the fish survived the experiment,
  where 0 means it died and 1 means that it survived.
  How many fish died? And how many survived?

```{r}
testthat::expect_equal(n_survived, sum(t_1$survived == TRUE))
testthat::expect_equal(n_died, sum(t_1$survived == FALSE))
```

- The `enclosure` column denotes the ID of an enclosure.
  How many enclosures are in this dataset?

```{r}
testthat::expect_equal(n_enclosures, length(unique(t_1$enclosure)))
```

- How many fish are in each enclosure?

```{r}
n_fish_per_enclosure <- dplyr::count(t_1, enclosure)
knitr::kable(n_fish_per_enclosure)
testthat::expect_equal(n_enclosures_with_2_fish, sum(n_fish_per_enclosure$n == 2))
testthat::expect_equal(n_enclosures_with_3_fish, sum(n_fish_per_enclosure$n == 3))
testthat::expect_equal(n_enclosures_with_4_fish, sum(n_fish_per_enclosure$n == 4))
```

Anomalies:

```{r}
testthat::expect_equal(anomous_enclosures, n_fish_per_enclosure[n_fish_per_enclosure$n != 3, ]$enclosure)
knitr::kable(n_fish_per_enclosure[n_fish_per_enclosure$n != 3, ])
```

## **Q0**. Describe the conclusion

- A conclusion drawn from the data
  is that the extreme body masses
  are likelier to survive. Would you agree that the data supports
  this claim?

## D4. Reproduce the results in that paper

- To make a better comparison, we are going to standarize
  body masses per enclosure. Add a column to the
  data called `cage_mass_mean` which holds the average
  `pre_mass` within the enclosure each fish is in.
  Could you show me the data for enclosure L1?

```{r}
cage_mass_mean_per_enclosure <- t_1 |> 
  dplyr::select(enclosure, pre_mass) |>
  dplyr::group_by(enclosure) |>
  dplyr::summarise(cage_mass_mean = mean(pre_mass))
t_2 <- merge(t_1, cage_mass_mean_per_enclosure)
knitr::kable(t_2)
knitr::kable(t_2[t_2$enclosure == "L1", ])
testthat::expect_equal(
  t_2[t_2$enclosure == "L1", ]$cage_mass_mean,
  rep(cage_mass_mean_for_l1, 3),
  tolerance = 1.0e-6
)
```

- ...

```{r}
sums_per_enclosure <- t_1 |> 
  dplyr::select(enclosure, cage_mass_mean_deviation_sd) |>
  dplyr::group_by(enclosure) |>
  dplyr::summarise(total = sum(cage_mass_mean_deviation_sd))
testthat::expect_equal(2.164935e-15, max(sums_per_enclosure$total, tolerance = 1.0e-16))
```

## **Q1**: Ask if the conclusion is correct

- A conclusion drawn from the data
  is that the extreme body masses
  are likelier to survive. Would you agree that the data supports
  this claim?


## D5 Reproduce the results that show a flaw in the reasoning

- ...

## **Q2**: Ask if the conclusion is correct

- A conclusion drawn from the data
  is that the extreme body masses
  are likelier to survive. Would you agree that the data supports
  this claim?
